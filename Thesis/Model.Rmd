---
title: "Model"
author: "Alex Eisert"
date: "1/8/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(keras)
library(dplyr)
```

```{r}
## Ellman examples; tried to predict next element in sequence; I'm trying to predict the same element each time (the last element)

## Change pos_y to plate crossing

data <- pitches

NumPitches <- 1 ## Number of pitches in the batch
TSperPitch <- 40 ## Number of timesteps to save from the current pitch
InputLength <- 3 ## Number of variables in the input

## y should have three dimensions, but they should be x pos, y post, and t, t being time the pitch crosses the plate

x <- array(0, dim = c(NumPitches, TSperPitch, InputLength))
y <- array(0, dim = c(NumPitches, TSperPitch, InputLength))

encode <- function(data, x){
  for (i in 1:InputLength){
    x[,,i] <- data[,i][1:TSperPitch]
  }
  return(x)
}

encode.y <- function(data, y){
  for (i in 1:InputLength){
    y[,,i] <- data[,i][nrow(data)]
  }
  return(y)
}

x
x <- encode(data, x)
y <- encode.y(data, y)

model <- keras_model_sequential()

model %>%
  layer_simple_rnn(units = 20, return_sequences = TRUE, input_shape=c(TSperPitch,InputLength)) %>%
  layer_dense(units = InputLength)

model %>% compile(
  loss = "mean_squared_error",
  optimizer = optimizer_nadam()
)

summary(model)

model %>% fit(
  pitches,
  pitches.y,
  epochs = 200
)

new_obs <- encode((First %>% select(pos_x, pos_y, pos_z)), x)
result <- predict(model, new_obs)

new_obs
result
nrow(First)
First[49,]
```

